---
layout: post                          
title: UDP协议                            
subtitle:                             
date: 2019-08-15                      
author: luojiaqi                      
header-img: img/post-bg-re-vs-ng2.jpg 
catalog: true                         
tags:                                 
    计算机网络                             
---

# TCP和UDP有哪些区别？
<table border="1" align="center">
   <tr>
      <td rowspan="2">类型</td>
      <td colspan="3">特点</td>
      <td colspan="2">性能</td>
      <td rowspan="2">应用场景</td>
      <td rowspan="2">首部字节</td>
   </tr>
   <tr>
      <td>是否面向连接</td>
      <td>传输可靠性</td>
      <td>传输形式</td>
      <td>传输效率</td>
      <td>所需资源</td>
   </tr>
   <tr>
      <td>TCP</td>
      <td>面向连接</td>
      <td>可靠</td>
      <td>字节流</td>
      <td>慢</td>
      <td>多</td>
      <td>要求数据可靠（如文件传输、邮件传输）</td>
      <td>20-60</td>
   </tr>
   <tr>
      <td>UDP</td>
      <td>面向无连接</td>
      <td>不可靠</td>
      <td>数组报文段</td>
      <td>快</td>
      <td>少</td>
      <td>要求通信速度高（如域名转换）</td>
      <td>8个字节（由4个字段组成）</td>
   </tr>
</table>
### 1.TCP面向连接，UDP面向无连接。

在互通之前，面向连接的协议会先建立连接，例如TCP会三次握手。为什么要建立连接呢？UDP也发三个包试试有什么区别吗？

所谓建立连接，是为了在客户端和服务端维护连接，建立一定的数据结构来维护双方交互的**状态**，用这样的数据结构来保证所谓的面向连接的特性。

### 2.TCP提供可靠交付

通过TCP连接传输的数据，无差错，不丢失，不重复，按序到达。

IP包是没有任何可靠性保证的，一旦发出去，走丢了、被妖怪吃了都只能随它去。UDP继承了IP包的特性：不保证不丢失，不保证按序到达。

### 3.TCP面向字节流

发送的时候发的是一个流，没头没尾。

而IP包不是一个流，是一个个的IP包。UDP继承了IP的特性：基于数据报的，一个一个地发，一个一个地收。

### 4.TCP可以有拥塞控制

当它意识到包丢弃了或者网络环境不好，会根据情况调整自己地行为，看看是不是发的太快了，要不要慢一点。

UDP则是：应用让我发我就发，不管路上有多堵。

### 5.TCP是有状态的

通俗讲就是有脑子，会精确记着是否发送了，是否接收了，发送到哪个了，应该接收哪个了，错一点都不行。

UDP则是无状态的，没脑子，发出去了就不管了。



MAC层定义了本地局域网的传输行为，IP层定义了整个网络端到端的传输行为



# UDP包头是什么样的？

![img](https://static001.geekbang.org/resource/image/6d/bf/6d1313f51b9dfd7ab454b2cef1cb37bf.jpg)

UDP报文格式很简单，报头由4个域组成。

无论上层应用程序使用TCP还是UDP，都要监听一个端口，正是这个端口用来区分应用程序，所以端口不能冲突，如果两个应用监听同一个端口，那数据报就不知道传给谁了。所以UDP报头里有源端口号和目的端口号。

UDP长度指包括报头和数据部分在内的总字节数，报头长度固定为8个字节。

# UDP的三大特点

### 1.沟通简单

### 2.轻信他人

### 3.

# UDP的三大使用场景

### 1.需要的资源少，在网络情况较好的内网，或者对于丢包不敏感的应用

DHCP就是基于UDP协议的，一般的获取IP地址都是内网请求，一次获取不到IP没关系，过一会儿还有机会。

PXE可以在启动的时候自动安装操作系统，操作系统镜像的下载使用的是TFTP，也是基于UDP协议的。在还没有操作系统时，客户端拥有的资源较少，不适合维护一个复杂的状态机（维护连接），而且因为是内网，一般没啥问题。

### 2.不需要一对一沟通，建立连接，而是可以广播的应用

UDP不面向连接，可以承载广播或多播的协议。DHCP就是一种广播的形式。

### 3.需要处理速度快，时延低，可以容忍少数丢包，即便网络拥塞也一往无前

UDP简单，处理速度快，不像TCP有各种复杂的机制（重传，拥塞控制，按序到达等等）。

当前很多应用要求低时延，不想要TCP如此复杂的机制，而是想根据自己的场景实现自己的可靠性和连接保证。比如：

如果应用觉得有的包丢了影响不大，那就没必要重传，有的比较重要，则应用自己重传，而不依赖于TCP。
有时候前面的包还没到达，后面的包先到了，那就先给客户展示后面的，不必非得按顺序来。

如果网络不好，丢了包，这时也不能降低传输速率。

## 基于UDP应用的五个例子

### 网页或者APP访问

原来访问网页和手机APP都是基于HTTP协议，HTTP是基于TCP的，建立连接需要多次交互，对于时延较大的移动互联网来说，建立一次连接的时间会比较长，而且由于终端在移动，TCP可能会断了重连，这样很耗时。而且目前HTTP协议往往采取多个数据通道共享一个TCP连接的情况，共享通道一定程度上能加快传输速度，但TCP的严格顺序策略使得哪怕共享通道，前一个不来，后一个和前一个即便没有关系，也得等着，这样时延也会增加。

**QUIC**（全称Quick UDP Internet Connections，快速UDP互联网连接）是Google提出的一种基于UDP改进的通信协议，目的是降低网络通信的延迟，提供更好的用户互动体验。

QUIC在应用层上，会自己实现快速建立连接、减少重传时延、自适应拥塞控制。

### 流媒体协议

直播协议多采用RTMP，这个协议是基于TCP的。TCP的严格顺序传输，对于直播来讲显然不合适，因为旧的视频帧丢了就算再传过来也没有意义，用户要看新的了，如果没传过来就等着，那就没有实时性了，对于直播来说，宁可丢包也不要卡顿。

对于视频播放来讲，有的包可丢有的包不能丢，视频的连续帧里面有的重要有的不重要，隔几个帧丢一个不重要的帧，用户可能感知不到，但如果连续丢帧，用户就能感知到了，所以网络不好的情况下，应用希望选择性的丢帧。

当网络不好的时候，TCP协议会主动降低发送速率，这对于本来就卡的视频来讲是要命的，应用层应该马上重传，而不是主动让步。因此，很多直播应用，都基于UDP实现了自己的视频传输协议。

### 实施游戏

游戏的实时性要求很高，快一秒你干掉别人，慢一秒你被别人干掉。

实时游戏中客户端和服务端要建立长连接，来保证实时传输。但游戏玩家众多，服务器却不多，维护TCP连接需要在内核维护一些数据结构，因此一台机器能够支撑的TCP连接数目有限。

TCP的严格顺序传输机制会使得，当一个数据包丢失时，所有事情都要停下来等待这个数据报重传，等待个1秒可能就被别人干掉了。

当游戏对实时要求较为严格时，采用自定义的可靠UDP协议，自定义重传策略，把丢包产生的延迟降到最低，尽量减少网络问题对游戏体验的影响。

### 物联网

物联网领域的终端资源少，可能只是个内存非常小的嵌入式系统，这时要维护TCP连接的代价就太大了，而且物联网对实时性要求很高，TCP时延太大。

Google旗下的Nest建立Thread Group，推出的物联网通信协议Thread就是基于UDP协议的。

### 移动通信领域

4G网络中，移动流量上网的数据面对的协议GTP-U时基于UDP的因为移动网络协议比较复杂，GTP协议本身就包含复杂的手机上线下线的通信协议，如果基于TCP，TCP的机制就显得非常多余。